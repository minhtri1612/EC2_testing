---
- name: Setup Pure OpenVPN Community Server
  hosts: vpn_server
  become: yes
  vars_files:
    - "group_vars/users.yml"
  vars:
    vpn_network: "10.8.0.0"
    vpn_mask: "255.255.255.0"
    vpc_cidr: "10.0.0.0"
    vpc_mask: "255.255.0.0"
    openvpn_public_ip: "{{ openvpn_public_ip | default('') }}"
    # Đường dẫn tuyệt đối đến easyrsa trên Debian 12
    easyrsa_bin: "/usr/share/easy-rsa/easyrsa"

  tasks:
    - name: Get default route interface for NAT
      ansible.builtin.shell: ip -o route get 1.1.1.1 | sed -n 's/.* dev \([^ ]*\) .*/\1/p'
      register: default_iface_result
      changed_when: false

    - name: Set VPN physical interface
      ansible.builtin.set_fact:
        vpn_physical_interface: "{{ default_iface_result.stdout | default('eth0') }}"

    - name: Install OpenVPN and Easy-RSA
      apt:
        name: [openvpn, easy-rsa, iptables-persistent]
        state: present
        update_cache: yes
      environment:
        DEBIAN_FRONTEND: noninteractive

    - name: Create OpenVPN and Server folders
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - /etc/openvpn/server
        - /etc/openvpn/server/ccd

    - name: Init PKI and CA
      shell: |
        make-cadir /etc/openvpn/easy-rsa
        cd /etc/openvpn/easy-rsa
        {{ easyrsa_bin }} init-pki
        echo "minhtri-ca" | {{ easyrsa_bin }} build-ca nopass
        {{ easyrsa_bin }} gen-dh
        openvpn --genkey secret /etc/openvpn/server/ta.key
      args:
        creates: /etc/openvpn/easy-rsa/pki/ca.crt

    - name: Generate Server Certificate
      shell: |
        {{ easyrsa_bin }} --batch --pki-dir=/etc/openvpn/easy-rsa/pki gen-req server nopass
        {{ easyrsa_bin }} --batch --pki-dir=/etc/openvpn/easy-rsa/pki sign-req server server
      args:
        creates: /etc/openvpn/easy-rsa/pki/issued/server.crt

    - name: Copy keys to Server folder
      copy:
        src: "/etc/openvpn/easy-rsa/pki/{{ item.src }}"
        dest: "/etc/openvpn/server/{{ item.dest }}"
        remote_src: yes
      with_items:
        - { src: 'ca.crt', dest: 'ca.crt' }
        - { src: 'issued/server.crt', dest: 'server.crt' }
        - { src: 'private/server.key', dest: 'server.key' }
        - { src: 'dh.pem', dest: 'dh.pem' }

    - name: Generate server.conf
      copy:
        dest: /etc/openvpn/server/server.conf
        content: |
          port 1194
          proto udp
          dev tun
          ca ca.crt
          cert server.crt
          key server.key
          dh dh.pem
          tls-auth ta.key 0
          server {{ vpn_network }} {{ vpn_mask }}
          push "route {{ vpc_cidr }} {{ vpc_mask }}"
          client-config-dir ccd
          cipher AES-256-GCM
          auth SHA256
          persist-key
          persist-tun
          verb 3

    - name: Enable IPv4 Forwarding
      sysctl:
        name: net.ipv4.ip_forward
        value: '1'
        state: present

    - name: Map static IPs (CCD)
      copy:
        dest: "/etc/openvpn/server/ccd/{{ item.name }}"
        content: "ifconfig-push {{ item.ip }} {{ vpn_mask }}"
      loop: "{{ vpn_users }}"

    - name: Generate client certificates
      shell: |
        {{ easyrsa_bin }} --batch --pki-dir=/etc/openvpn/easy-rsa/pki gen-req {{ item.name }} nopass
        {{ easyrsa_bin }} --batch --pki-dir=/etc/openvpn/easy-rsa/pki sign-req client {{ item.name }}
      args:
        creates: "/etc/openvpn/easy-rsa/pki/issued/{{ item.name }}.crt"
      loop: "{{ vpn_users }}"

    - name: Build .ovpn files for team
      shell: |
        set -e
        F="/home/admin/{{ item.name }}.ovpn"
        {
          echo "client"
          echo "dev tun"
          echo "proto udp"
          echo "remote {{ openvpn_public_ip }} 1194"
          echo "resolv-retry infinite"
          echo "nobind"
          echo "persist-key"
          echo "persist-tun"
          echo "remote-cert-tls server"
          echo "cipher AES-256-GCM"
          echo "auth SHA256"
          echo "key-direction 1"
          echo "verb 3"
          echo "<ca>"
          cat /etc/openvpn/server/ca.crt
          echo "</ca>"
          echo "<cert>"
          cat /etc/openvpn/easy-rsa/pki/issued/{{ item.name }}.crt
          echo "</cert>"
          echo "<key>"
          cat /etc/openvpn/easy-rsa/pki/private/{{ item.name }}.key
          echo "</key>"
          echo "<tls-auth>"
          cat /etc/openvpn/server/ta.key
          echo "</tls-auth>"
        } > "$F"
        chown admin:admin "$F"
        chmod 600 "$F"
      loop: "{{ vpn_users }}"
      when: openvpn_public_ip | length > 0

    - name: Setup IPTables
      iptables:
        table: "{{ item.table | default('filter') }}"
        chain: "{{ item.chain }}"
        source: "{{ vpn_network }}/24"
        out_interface: "{{ item.out_if | default(omit) }}"
        jump: ACCEPT
      loop:
        - { chain: 'FORWARD' }
        - { chain: 'POSTROUTING', table: 'nat', out_if: "{{ vpn_physical_interface }}", jump: 'MASQUERADE' }

    - name: Save iptables
      shell: iptables-save > /etc/iptables/rules.v4

    - name: Restart OpenVPN
      systemd:
        name: openvpn-server@server
        state: restarted
        enabled: yes

    # Tải .ovpn về máy chạy Ansible (cùng kết nối SSH, tránh SCP timeout khi IP đổi)
    - name: Fetch .ovpn files to project root (control node)
      ansible.builtin.fetch:
        src: "/home/admin/{{ item.name }}.ovpn"
        dest: "{{ playbook_dir }}/../"
        flat: yes
      loop: "{{ vpn_users }}"
      when: openvpn_public_ip | length > 0